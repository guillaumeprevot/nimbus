<!DOCTYPE html>
<html class="nimbus-viewer nimbus-static-toolbars">
<head>
<title data-translate="text">CodeEditorTitle</title>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link type="image/x-icon" rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="/preferences/theme.css" />
<link type="text/css" rel="stylesheet" href="/libs/material-icons/material-icons-custom.css" />
<link type="text/css" rel="stylesheet" href="/libs/codemirror/lib/codemirror.css" />
<link type="text/css" rel="stylesheet" href="/libs/codemirror/addon/hint/show-hint.css" />
<link type="text/css" rel="stylesheet" href="/nimbus.css" />
<style>
.CodeMirror { width: 100%; height: 100%; }
.cm-trailingspace { border-bottom: 2px dotted red; }
</style>
<script type="text/javascript" src="/libs/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/libs/popper/popper.min.js"></script>
<script type="text/javascript" src="/libs/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/libs/codemirror/lib/codemirror.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/comment/comment.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/comment/continuecomment.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/matchbrackets.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/closebrackets.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/matchtags.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/closetag.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/continuelist.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/trailingspace.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/fold/xml-fold.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/show-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/xml-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/javascript-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/html-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/css-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/search/jump-to-line.js"></script><!-- Alt+G : https://codemirror.net/addon/search/jump-to-line.js -->
<script type="text/javascript" src="/libs/codemirror/addon/selection/active-line.js"></script>
<script type="text/javascript" src="/nimbus.js"></script>
<script type="text/javascript" src="/langs/${lang}.js"></script>
</head>
<body class="nimbus-hidden">
	<header>
		<div class="float-left">
			<a href="#" class="btn btn-link back" style="display: none;"><i class="material-icons">arrow_back</i></a>
			<button id="saveButton" type="button" class="btn btn-link nimbus-hidden" data-translate="title" title="TextEditorSave"><i class="material-icons">save</i></button>
		</div>

		<div class="btn-group">
		</div>

		<div class="float-right">
			<div class="btn-group">
				<button id="optionsButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="CodeEditorOptions" aria-haspopup="true" aria-expanded="false"><i class="material-icons">settings</i></button>
				<div id="optionsMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="optionsButton">
					<button class="dropdown-item active" id="optionsIndentWithTabs" data-translate="text">CodeEditorOptionsIndentWithTabs</button>
					<button class="dropdown-item" id="optionsRTLDirection" data-translate="text">CodeEditorOptionsRTLDirection</button>
					<button class="dropdown-item" id="optionsLineWrapping" data-translate="text">CodeEditorOptionsLineWrapping</button>
					<button class="dropdown-item active" id="optionsLineNumbers" data-translate="text">CodeEditorOptionsLineNumbers</button>
				</div>
			</div>
			<div class="btn-group">
				<button id="themeButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="CodeEditorTheme" aria-haspopup="true" aria-expanded="false"><i class="material-icons">color_lens</i></button>
				<div id="themeMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="themeButton">
					<button class="dropdown-item" data-theme="" data-translate="text">CodeEditorThemeNone</button>
					<button class="dropdown-item" data-theme="default" data-translate="text">CodeEditorThemeDefault</button>
					<div class="dropdown-divider"></div>
					<#list "base16-dark,base16-light,eclipse,material,xq-dark,xq-light"?split(",") as theme>
					<button class="dropdown-item" data-theme="${theme}">${theme}</button>
					</#list>
				</div>
			</div>
			<div class="btn-group">
				<button id="lineSeparatorButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="TextEditorLineSeparator" aria-haspopup="true" aria-expanded="false"><i class="material-icons">wrap_text</i></button>
				<div id="lineSeparatorMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="lineSeparatorButton">
					<button class="dropdown-item" data-separator="crlf" data-translate="text">TextEditorLineSeparatorCRLF</button>
					<button class="dropdown-item" data-separator="lf" data-translate="text">TextEditorLineSeparatorLF</button>
					<button class="dropdown-item" data-separator="cr" data-translate="text">TextEditorLineSeparatorCR</button>
				</div>
			</div>
		</div>
	</header>
	<main>
	</main>
	<footer>
	</footer>
<script>
"use strict";

function getLineSeparator(content) {
	if (!content || content.indexOf('\r\n') >= 0)
		return 'crlf';
	if (content.indexOf('\n') >= 0)
		return 'lf';
	return 'cr';
}

//Charger les fonctions liées à CodeMirror
function initCodeMirror(content, filename) {
	// Extension du fichier, qui va nous indiquer les fonctions à mettre en place
	var extension = filename.substring(filename.lastIndexOf('.') + 1);
	// Objet du plugin 'code.js' indiquant les fonctions supportées pour CodeMirror
	var support = NIMBUS.utils.codeMirrorSupport[extension];
	// Injection des scripts pour le langage déduit de l'extension
	support.mode.split(',').forEach(function(mode) {
		if (mode === 'null')
			return;
		$('<script />')
			.attr('type', 'text/javascript')
			.attr('src', '/libs/codemirror/mode/' + mode + '/' + mode + '.js')
			.appendTo(document.head);
	});
	// Configuration : https://codemirror.net/doc/manual.html#config
	var options = {
		value: content,
		mode: support.mime || '',
		// lineSeparator: null,
		// theme: 'default',
		indentUnit: 4,
		// smartIndent: true,
		// tabSize: 4,
		indentWithTabs: true,
		// electricChars: true,
		// direction: 'ltr' 'rtl',
		// rtlMoveVisually: true false,
		// lineWrapping: false,
		lineNumbers: true,
		// scrollbarStyle: 'native' 'null' ...
		viewportMargin: Infinity,

		styleActiveLine: true,
		continueComments: true,
		matchBrackets: true,
		autoCloseBrackets: true,
		matchTags: true,
		autoCloseTags: true,
		showTrailingSpace: true,
		extraKeys: {
			'Ctrl-Space': 'autocomplete',
			'Ctrl-Alt-F': function() {
				var from = cm.getCursor(true);
				var to = cm.getCursor(false);
				cm.operation(function () {
					for (var i = from.line; i <= to.line; i++) {
						cm.indentLine(i, 'smart');
					}
				});
			},
			'Ctrl-Alt-C': 'toggleComment' // Shift-Ctrl-C utilisé par Firefox
		}
	};
	if (support.mime === 'text/x-markdown')
		$.extend(options.extraKeys, {
			'Enter': 'newlineAndIndentContinueMarkdownList'
		});
	// Composant d'édition riche
	var cm = CodeMirror(document.querySelector('main'), options);
	cm.on('change', function() {
		$('#saveButton').removeClass('nimbus-hidden');
	});

	// Choix du thème (https://codemirror.net/demo/theme.html)
	$('#themeMenu').click('button', function(event) {
		var button = $(event.target).closest('button')
		var theme = button.attr('data-theme');
		if (theme)
			$('<link type="text/css" rel="stylesheet" />').attr('href', '/libs/codemirror/theme/' + theme + '.css').appendTo('head');
		cm.setOption('theme', theme || '');
		localStorage.setItem('nimbus-codemirror-theme', theme || 'none');
		button.addClass('active').siblings().removeClass('active');
	});
	// Chargement du thème sauvegardé
	var theme = localStorage.getItem('nimbus-codemirror-theme');
	if (theme === 'none')
		cm.setOption('theme', '');
	else
		$('#themeMenu button[data-theme=' + theme + ']').click();

	// Autres options
	$('#optionsIndentWithTabs').click(function() {
		var self = $(this).toggleClass('active');
		cm.setOption('indentWithTabs', self.hasClass('active'));
	});
	$('#optionsRTLDirection').click(function() {
		var self = $(this).toggleClass('active');
		cm.setOption('direction', self.hasClass('active') ? 'rtl' : 'ltr');
	});
	$('#optionsLineWrapping').click(function() {
		var self = $(this).toggleClass('active');
		cm.setOption('lineWrapping', self.hasClass('active'));
	});
	$('#optionsLineNumbers').click(function() {
		var self = $(this).toggleClass('active');
		cm.setOption('lineNumbers', self.hasClass('active'));
	});

	return cm;
}

//Initialiser la page
NIMBUS.init(['text.js', 'code.js'], function() {
	// En haut à gauche, le bouton "Retour"
	$('.back').toggle(!!'${fromUrl}').attr('title', '${fromTitle}').attr('href', '${fromUrl}');
	// L'IHM est prête, on l'affiche
	$(document.body).removeClass('nimbus-hidden');
	// Identifiant de l'élément édité
	var itemId = ${itemId};
	// Récupération du contenu du fichier
	$.get({
		url: '/files/stream/' + itemId,
		dataType: 'text'
	}).then(function(content, textStatus, jqXHR) {
		var lineSeparator = getLineSeparator(content),
			saveButton = $('#saveButton'),
			filename = NIMBUS.utils.getFileNameFromContentDisposition(jqXHR);

		var cm = initCodeMirror(content, filename);

		$('title').text(filename);

		$('#lineSeparatorMenu').find('[data-separator=' + lineSeparator + ']').addClass('active');
		$('#lineSeparatorMenu').click('button', function(event) {
			var button = $(event.target).closest('button');
			lineSeparator = button.attr('data-separator');
			button.addClass('active').siblings().removeClass('active');
			saveButton.removeClass('nimbus-hidden');
		});

		saveButton.on('click', function() {
			var text = cm.getValue(lineSeparator.replace('cr', '\r').replace('lf', '\n'));
			NIMBUS.utils.updateFile(itemId, new Blob([text], { type: "text/plain" })).then(function() {
				saveButton.addClass('nimbus-hidden').removeClass('text-danger');
			}, function() {
				saveButton.addClass('text-danger');
			})
		});
	});
});
</script>

</body>
</html>
