<!DOCTYPE html>
<html class="nimbus-viewer nimbus-static-toolbars">
<head>
<title data-translate="text">CodeEditorTitle</title>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link type="image/x-icon" rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="/preferences/theme.css" />
<link type="text/css" rel="stylesheet" href="/libs/material-icons/material-icons-custom.css" />
<link type="text/css" rel="stylesheet" href="/libs/codemirror/lib/codemirror.css" />
<link type="text/css" rel="stylesheet" href="/libs/codemirror/addon/hint/show-hint.css" />
<link type="text/css" rel="stylesheet" href="/libs/codemirror/theme/nimbus-${theme}.css" />
<link type="text/css" rel="stylesheet" href="/nimbus.css" />
<style>
.CodeMirror { width: 100%; height: 100%; line-height: 1.3em; }
.cm-trailingspace { border-bottom: 2px dotted red; }
</style>
<script type="text/javascript" src="/libs/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/libs/popper/popper.min.js"></script>
<script type="text/javascript" src="/libs/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/libs/codemirror/lib/codemirror.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/comment/comment.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/comment/continuecomment.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/matchbrackets.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/closebrackets.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/matchtags.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/closetag.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/continuelist.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/edit/trailingspace.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/fold/xml-fold.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/show-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/xml-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/javascript-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/html-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/hint/css-hint.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/search/jump-to-line.js"></script>
<script type="text/javascript" src="/libs/codemirror/addon/selection/active-line.js"></script>
<script type="text/javascript" src="/nimbus.js"></script>
<script type="text/javascript" src="/langs/${lang}.js"></script>
</head>
<body class="nimbus-hidden">
	<header class="bg-primary">
		<div class="float-left">
			<a href="#" class="btn btn-link back" style="display: none;"><i class="material-icons">arrow_back</i></a>
			<button id="saveButton" type="button" class="btn btn-link nimbus-hidden" data-translate="title" title="TextEditorSave"><i class="material-icons">save</i></button>
		</div>

		<div class="btn-group">
		</div>

		<div class="float-right">
			<div class="btn-group">
				<button id="optionsButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="CodeEditorOptions" aria-haspopup="true" aria-expanded="false"><i class="material-icons">settings</i></button>
				<div id="optionsMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="optionsButton">
					<button class="dropdown-item active" id="optionsIndentWithTabs" data-translate="text">CodeEditorOptionsIndentWithTabs</button>
					<button class="dropdown-item" id="optionsRTLDirection" data-translate="text">CodeEditorOptionsRTLDirection</button>
					<button class="dropdown-item" id="optionsLineWrapping" data-translate="text">CodeEditorOptionsLineWrapping</button>
					<button class="dropdown-item active" id="optionsLineNumbers" data-translate="text">CodeEditorOptionsLineNumbers</button>
				</div>
			</div>
			<div class="btn-group">
				<button id="lineSeparatorButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="TextEditorLineSeparator" aria-haspopup="true" aria-expanded="false"><i class="material-icons">wrap_text</i></button>
				<div id="lineSeparatorMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="lineSeparatorButton">
					<button class="dropdown-item" data-separator="crlf" data-translate="text">TextEditorLineSeparatorCRLF</button>
					<button class="dropdown-item" data-separator="lf" data-translate="text">TextEditorLineSeparatorLF</button>
					<button class="dropdown-item" data-separator="cr" data-translate="text">TextEditorLineSeparatorCR</button>
				</div>
			</div>
		</div>
	</header>
	<main>
	</main>
	<footer></footer>
<script>
"use strict";

/** This method detects and returns the line separator used in content */
function getLineSeparator(content) {
	if (!content || content.indexOf('\r\n') >= 0)
		return 'crlf';
	if (content.indexOf('\n') >= 0)
		return 'lf';
	return 'cr';
}

/** This method prepares the options used to create the CodeMirror instance */
function createCodeMirrorOptions(mime, content) {
	// https://codemirror.net/doc/manual.html#config
	var options = {
		value: content,
		mode: mime || '',
		// lineSeparator: null,
		theme: 'nimbus-${theme}',
		indentUnit: 4,
		// smartIndent: true,
		// tabSize: 4,
		indentWithTabs: true,
		// electricChars: true,
		// direction: 'ltr' 'rtl',
		// rtlMoveVisually: true false,
		// lineWrapping: false,
		lineNumbers: true,
		// scrollbarStyle: 'native' 'null' ...
		viewportMargin: Infinity,

		styleActiveLine: true,
		continueComments: true,
		matchBrackets: true,
		autoCloseBrackets: true,
		matchTags: true,
		autoCloseTags: true,
		showTrailingSpace: true,
		// Defaults keymap : https://github.com/codemirror/CodeMirror/blob/master/src/input/keymap.js
		extraKeys: {
			'Ctrl-Space': 'autocomplete',
			'Ctrl-Alt-C': 'toggleComment',
			'Ctrl-L': 'jumpToLine'
		}
	};
	if (mime === 'text/x-markdown')
		options.extraKeys['Enter'] = 'newlineAndIndentContinueMarkdownList';
	return options;
}

//Initialiser la page
NIMBUS.init(['text.js', 'code.js'], function() {
	// En haut à gauche, le bouton "Retour"
	$('.back').toggle(!!'${fromUrl}').attr('title', '${fromTitle}').attr('href', '${fromUrl}');
	// L'IHM est prête, on l'affiche
	$(document.body).removeClass('nimbus-hidden');
	// Identifiant de l'élément édité
	var itemId = ${itemId};
	// Récupération du contenu du fichier
	$.get({
		url: '/files/stream/' + itemId,
		dataType: 'text'
	}).then(function(content, textStatus, jqXHR) {
		// Find the save button (would upload content to the server on click)
		var saveButton = $('#saveButton');
		// Extract the text file name from HTTP response header
		var filename = NIMBUS.utils.getFileNameFromContentDisposition(jqXHR);
		// Show filename as page title (=> in browser tab)
		$('title').text(filename);
		// Extract the file name extension for feature detection
		var extension = filename.substring(filename.lastIndexOf('.') + 1);
		// Get file support definition (shared by 'code.js' into the NIMBUS.utils object)
		var support = NIMBUS.utils.codeMirrorLoadSupport(extension);
		// Get CodeMirror configuration options
		var options = createCodeMirrorOptions(support.mime, content);
		// Composant d'édition riche
		var cm = CodeMirror(document.querySelector('main'), options);
		cm.on('change', function() {
			saveButton.removeClass('nimbus-hidden');
		});

		// Line separator menu
		var lineSeparatorMenu = $('#lineSeparatorMenu');
		var lineSeparator = getLineSeparator(content);
		lineSeparatorMenu.click('button', function(event) {
			var button = $(event.target).closest('button');
			lineSeparator = button.attr('data-separator');
			button.addClass('active').siblings().removeClass('active');
			saveButton.removeClass('nimbus-hidden');
		});
		// Ensure that the current line separator is selected in menu
		lineSeparatorMenu.children('[data-separator=' + lineSeparator + ']').addClass('active');

		// Other options
		$('#optionsIndentWithTabs').click(function() {
			var self = $(this).toggleClass('active');
			cm.setOption('indentWithTabs', self.hasClass('active'));
		});
		$('#optionsRTLDirection').click(function() {
			var self = $(this).toggleClass('active');
			cm.setOption('direction', self.hasClass('active') ? 'rtl' : 'ltr');
		});
		$('#optionsLineWrapping').click(function() {
			var self = $(this).toggleClass('active');
			cm.setOption('lineWrapping', self.hasClass('active'));
		});
		$('#optionsLineNumbers').click(function() {
			var self = $(this).toggleClass('active');
			cm.setOption('lineNumbers', self.hasClass('active'));
		});

		// Implementing "save" command, invoked by default key maps on "Ctrl+S" or "Cmd+S".
		CodeMirror.commands.save = function(cm) {
			var text = cm.getValue(lineSeparator.replace('cr', '\r').replace('lf', '\n'));
			NIMBUS.utils.updateFile(itemId, new Blob([text], { type: "text/plain" })).then(function() {
				saveButton.addClass('nimbus-hidden').removeClass('text-danger');
			}, function() {
				saveButton.addClass('text-danger');
			});
		};
		saveButton.on('click', function() {
			CodeMirror.commands.save(cm);
		});

	});
});
</script>

</body>
</html>
