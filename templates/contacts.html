<!DOCTYPE html>
<html class="nimbus-viewer nimbus-static-toolbars">
<head>
<title data-translate="text">ContactsTitle</title>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link type="image/x-icon" rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="${stylesheet}" />
<link type="text/css" rel="stylesheet" href="/libs/material-icons/material-icons.css" />
<link type="text/css" rel="stylesheet" href="/nimbus.css" />
<style>
header { display: flex; flex-direction: row; }
header > .btn { flex: none; }
header > #spacer { flex: auto; }
header > #searchInput { flex: auto; max-width: 420px; }
header > #searchInput:not(.active):not(:focus) { background-color: transparent; }

main { display: flex; flex-direction: column; padding: 10px; }
main > .nav { flex: none; }
main > .table { flex: auto; }

table tbody { cursor: pointer; }
table tbody + caption { text-align: center; }
table tbody:not(:empty) + caption { display: none; }

#actionsModal .material-icons { font-size: 20px; width: 20px; height: 20px; }
</style>
<script type="text/javascript" src="/libs/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/libs/popper/popper.min.js"></script>
<script type="text/javascript" src="/libs/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/libs/moment/moment.min.js"></script>
<#if lang == "fr"><script type="text/javascript" src="/libs/moment/fr.js"></script></#if>
<script type="text/javascript" src="/libs/gp/gp.js"></script>
<script type="text/javascript" src="/nimbus.js"></script>
<script type="text/javascript" src="/langs/${lang}.js"></script>
</head>
<body class="nimbus-hidden">
	<header class="bg-primary">
		<a href="#" class="btn btn-link back" style="display: none;"><i class="material-icons">arrow_back</i></a>
		<button id="saveButton" type="button" class="btn btn-link nimbus-hidden" data-translate="title" title="ContactsSave"><i class="material-icons">save</i></button>
		<span id="spacer"></span>
		<input id="searchInput" type="search" class="form-control" data-translate="placeholder" placeholder="ContactsSearchPlaceholder" />
		<button id="addContactButton" type="button" class="btn btn-link" data-translate="title" title="ContactAddButton"><i class="material-icons">add</i></button>
		<button id="renameButton" type="button" class="btn btn-link" data-translate="title" title="ContactsRename"><i class="material-icons">edit</i></button>
	</header>
	<main>
		<ul id="navigation" class="nav nav-tabs"></ul>
		<table id="table" class="table table-hover">
			<thead><tr></tr></thead>
			<tbody></tbody>
			<caption>Aucun contact pour le moment</caption>
		</table>
	</main>
	<div id="alert-container"></div>
	<footer class="bg-secondary"></footer>
	<form>
		<div id="actionsModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-body">
						<div class="list-group">
							<div class="list-group-item active">DISPLAY_NAME</div>
							<button id="editContactButton" type="button" class="list-group-item list-group-item-action">
								<i class="material-icons">edit</i>
								<span data-translate="text">ContactEditButton</span>
							</button>
							<button id="deleteContactButton" type="button" class="list-group-item list-group-item-action text-danger">
								<i class="material-icons">delete</i>
								<span data-translate="text">ContactDeleteButton</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="contactModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" data-translate="text">ContactModalTitle</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="contactDisplayName" data-translate="text">ContactModalDisplayNameLabel</label>
							<input id="contactDisplayName" type="text" class="form-control" data-translate="placeholder" placeholder="ContactModalDisplayNamePlaceholder" autofocus="autofocus" />
						</div>
						<div class="form-group">
							<div class="custom-control custom-switch">
								<input type="checkbox" class="custom-control-input" id="contactArchive">
								<label class="custom-control-label" for="contactArchive" data-translate="text">ContactModalArchiveLabel</label>
							</div>
						</div>
						<div class="form-group">
							<label for="contactGender" data-translate="text">ContactModalGenderLabel</label>
							<select id="contactGender" class="form-control">
								<option value="" data-translate="text">ContactGenderUnspecified</option>
								<option value="male" data-translate="text">ContactGenderMale</option>
								<option value="female" data-translate="text">ContactGenderFemale</option>
								<option value="other" data-translate="text">ContactGenderOther</option>
							</select>
						</div>
						<div class="form-group">
							<label for="contactNote" data-translate="text">ContactModalNoteLabel</label>
							<textarea id="contactNote" class="form-control" data-translate="placeholder" placeholder="ContactModalNotePlaceholder"></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-link" data-translate="text" data-dismiss="modal">ContactModalCancelButton</button>
						<button id="contactValidateButton" type="button" class="btn btn-primary">
							<span class="add" data-translate="text">ContactModalAddButton</span>
							<span class="apply" data-translate="text">ContactModalApplyButton</span>
						</button>
					</div>
				</div>
			</div>
		</div>
	</form>
<script>
"use strict";

// Le format de date moment correspondant aux "input[type=date]"
var inputDateFormat = 'YYYY-MM-DD';

// La liste des colonnes
var columns = [
	{ name: 'picture', title: 'ContactPicture', content: (c) => (c.picture ? $('<img />').attr('src', '/files/thumbnail/' + c.picture + '?size=32').css('clip-path', 'circle(50%)') : '') },
	{ name: 'archive', title: 'ContactArchive', content: (c) => c.archive ? '<i class="material-icons">check_box</i>' : '<i class="material-icons">check_box_outline_blank</i>' },
	{ name: 'displayName', title: 'ContactDisplayName', content: (c) => c.displayName || (c.firstName + ' ' + c.lastName) },
	{ name: 'email1', title: 'ContactEmail', content: (c) => findIn(c.emails, 0, NIMBUS.utils.contactAPI.createEmailLink) },
	{ name: 'email2', title: 'ContactEmail', content: (c) => findIn(c.emails, 1, NIMBUS.utils.contactAPI.createEmailLink) },
	{ name: 'phone1', title: 'ContactPhone', content: (c) => findIn(c.phones, 0, NIMBUS.utils.contactAPI.createPhoneLink) },
	{ name: 'phone2', title: 'ContactPhone', content: (c) => findIn(c.phones, 1, NIMBUS.utils.contactAPI.createPhoneLink) },
	{ name: 'url1', title: 'ContactURL', content: (c) => findIn(c.urls, 0, NIMBUS.utils.contactAPI.createURLLink) },
	{ name: 'keywords', title: 'ContactKeywords', content: (c) => c.keywords ? c.keywords.join(',') : '' },
];

// Cette méthode recherche dans "array" la valeur à la position "index", si "array" est suffisamment grand, et renvoie la valeur formatée par "format"
function findIn(array, index, format) {
	if (!array || index >= array.length)
		return '';
	return format(array[index]);
}

// Cette méthode vérifier si le contact correspond au texte recherché
function matchSearch(contact, searchTextLC) {
	return (contact.displayName || (contact.firstName + ' ' + contact.lastName)).toLowerCase().indexOf(searchTextLC) >= 0;
}

// Cette méthode filtre la grille en fonction du texte recherché
function updateSearch() {
	var searchTextLC = $('#searchInput').val().toLowerCase();
	$('#table > tbody > tr').each(function() {
		var tr = $(this);
		var contact = tr.data('contact');
		tr.toggle(!searchTextLC || matchSearch(contact, searchTextLC));
	});
}

// Cette méthode charge la grille avec le contenu du carnet d'adresses sélectionné
function updateTable(source) {
	var searchTextLC = $('#searchInput').val().toLowerCase();
	var headers = $('#table > thead > tr');
	if (headers.is(':empty'))
		columns.forEach((c) => $('<th scope="col" />').text(NIMBUS.translate(c.title)).attr('data-name', c.name).appendTo(headers));
	var contacts = $('#table > tbody');
	contacts.empty().append(source.contacts.map(function(contact) {
		var tr = $('<tr />').data('contact', contact);
		tr.toggle(!searchTextLC || matchSearch(contact, searchTextLC));
		columns.forEach((c) => $('<td />').append(c.content(contact)).appendTo(tr));
		return tr.get(0);
	}));
}

function editContact(source, contact, isNew, callback) {
	// Préparer le formulaire
	var displayNameInput = $('#contactDisplayName').val(contact.displayName || '');
	var archiveCheckbox = $('#contactArchive').prop('checked', !!contact.archive);
	var genderSelect = $('#contactGender').val(contact.gender || '');
	var noteTextarea = $('#contactNote').val(contact.note || '');
	// Ajuster le bouton de validation (ajout ou modification ?)
	$('#contactValidateButton .add').toggle(isNew).siblings('.apply').toggle(!isNew);
	// Ajuster l'action de validation au contexte en cours
	$('#contactValidateButton').off('click').on('click', function() {
		var api = NIMBUS.utils.contactAPI;
		// Ajuster les données
		contact.displayName = displayNameInput.val() || undefined;
		contact.archive = archiveCheckbox.prop('checked');
		contact.gender = genderSelect.val() || undefined;
		contact.note = noteTextarea.val() || undefined;
		if (isNew)
			source.contacts.push(contact);
		// Fermer la fenêtre modale
		$('#contactModal').modal('hide');
		// Appeler la callback
		callback();
	});
	// Afficher la fenêtre modale
	$('#contactModal').modal();
}

//Initialiser la page
NIMBUS.init(['contacts.js'], function() {
	// En haut à gauche, le bouton "Retour"
	$('.back').toggle(!!'${fromUrl}').attr('title', '${fromTitle}').attr('href', '${fromUrl}');

	// L'IHM est prête, on l'affiche
	var body = $(document.body).removeClass('nimbus-hidden');

	// Identifiant de l'élément édité
	var itemId = ${itemId!"null"};

	// Récupération des différents calendrier
	$.get('/items/list', {
		recursive: true,
		sortBy: 'name',
		sortAscending: true,
		folders: false,
		hidden: null,
		deleted: false,
		extensions: 'contacts'
	}).then(function(items) {
		// Récupération de l'API
		var api = NIMBUS.utils.contactAPI;
		// Création des sources
		var sources = items.map((item) => new api.ContactSource(item));
		// Chargement des sources
		return Promise.all(sources.map((s) => s.load())).then((results) => {
			// console.log(sources);
			return sources;
		});
	}).then(function(sources) {
		// Récupération de l'API
		var api = NIMBUS.utils.contactAPI;

		// Gestion du bouton de sauvegarde
		var saveButton = $('#saveButton');
		var autosave = (window.location.search || '').indexOf('autosave=true') >= 0;
		var data = $(sources);

		data.on('contactsourcechange', function(event, source) {
			source.modified = true;
			if (autosave) {
				saveButton.click();
			} else {
				saveButton.removeClass('nimbus-hidden');
			}
		});

		saveButton.on('click', function() {
			var promises = sources.filter((s) => s.modified).map((s) => s.save());
			Promise.all(promises).then(() => {
				sources.forEach((s) => delete s.modified);
				saveButton.addClass('nimbus-hidden');
			}, () => {
				NIMBUS.message(NIMBUS.translate('ContactSaveError'), true);
				saveButton.removeClass('nimbus-hidden');
			});
		});

		// Préparation des onglets pour passer d'un carnet d'adresse à un autre
		var navigation = $('#navigation');
		// Positionnement sur l'onglet demandé dans l'URL ou sur le premier par défaut
		var selectedSource = (itemId === null) ? sources[0] : sources.find((s) => s.item.id === itemId);
		// Création d'un onglet par fichier ".contacts"
		navigation.append(sources.map(function(source, index) {
			var a = $('<a class="nav-link" href="#" />')
				.toggleClass('active', source === selectedSource)
				.text(source.getNameOrDefault());
			return $('<li class="nav-item" />')
				.append(a)
				.get(0);
		}));
		// Chargement du fichier quand on clique sur son onglet
		navigation.on('click', '.nav-item', function() {
			var item = $(event.target).closest('.nav-item');
			var index = item.index();
			item.children().addClass('active');
			item.siblings().children().removeClass('active')
			selectedSource = sources[index];
			updateTable(selectedSource);
		});
		// Chargement initial de la grille
		updateTable(selectedSource);

		// Configuration de la zone de recherche
		$('#searchInput').val('').change(function() {
			// Marquer de la classe active pour forcer le fond blanc (cf <style />)
			$(this).toggleClass('active', !!this.value);
			// Filtrer la table en fonction de la recherche
			updateSearch();
		});

		// Clic sur le bouton pour ajouter un contact
		$('#addContactButton').click(function() {
			// Créer un contact vide
			var newContact = {};
			// Editer ce contact 
			editContact(selectedSource, newContact, true, function() {
				// Gérer la sauvegarde
				data.trigger('contactsourcechange', selectedSource);
				// Raffraichir la page
				updateTable(selectedSource);
			});
		});

		// Sélection de l'entrée de menu pour éditer un contact existant
		$('#editContactButton').on('click', function() {
			// Cacher la fenêtre
			var modal = $('#actionsModal').modal('hide');
			// Récupérer le contact
			var contact = modal.data('contact');
			// Editer le contact
			editContact(selectedSource, contact, false, function() {
				// Gérer la sauvegarde
				data.trigger('contactsourcechange', selectedSource);
				// Raffraichir la page
				updateTable(selectedSource);
			});
		});

		// Sélection de l'entrée de menu pour supprimer un contact existant
		$('#deleteContactButton').on('click', function() {
			// Cacher la fenêtre
			var modal = $('#actionsModal').modal('hide');
			// Récupérer le contact
			var contact = modal.data('contact');
			// Supprimer le contact
			selectedSource.contacts.splice(selectedSource.contacts.indexOf(contact), 1);
			// Gérer la sauvegarde
			data.trigger('contactsourcechange', selectedSource);
			// Raffraichir la page
			updateTable(selectedSource);
		});

		// Sélection d'un contact en cliquant dessus dans la grille
		$('#table').on('click', 'tbody > tr', function(event) {
			// Na pas afficher le menu si on a cliqué sur un lien (email, phone, url, ...)
			var target = $(event.target);
			if (target.closest('a').length > 0)
				return;
			// Récupérer le contact cliqué
			var contact = $(event.target).closest('tr').data('contact');
			// Afficher le menu d'action
			var modal = $('#actionsModal').data('contact', contact).modal();
			// Afficher le nom du contact en haut du menu
			modal.find('.list-group-item.active').text(contact.displayName || (contact.firstName + ' ' + contact.lastName));
		});

		// Clic sur le bouton pour renommer un carnet d'adresse
		$('#renameButton').click(function() {
			// Demander le nouveau nom
			NIMBUS.prompt(NIMBUS.translate('ContactsRenameTitle'), selectedSource.getNameOrDefault(), '').then(function(newName) {
				// Renommer la source
				selectedSource.name = newName.trim() || null;
				// Ajuster le titre de l'onglet associé
				navigation.find('.active').text(selectedSource.getNameOrDefault());
				// Gérer la sauvegarde
				data.trigger('contactsourcechange', selectedSource);
			});
		});

		// Manipulation au clavier
		body.keystrokes({
			'Ctrl-f': () => $('#searchInput').focus().select(),
			'Ctrl-s': () => saveButton.click(),
		});

		// Désactivation de la soumission des formulaires
		$('form').on('submit', function() { return false; });
	});
});
</script>

</body>
</html>
