<!DOCTYPE html>
<html class="nimbus-viewer nimbus-static-toolbars">
<head>
<title data-translate="text">TextEditorTitle</title>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link type="image/x-icon" rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="/preferences/theme.css" />
<link type="text/css" rel="stylesheet" href="/libs/material-icons/material-icons-custom.css" />
<#if markdown><link type="text/css" rel="stylesheet" href="/libs/prism/prism.min.css" /></#if>
<link type="text/css" rel="stylesheet" href="/nimbus.css" />
<style>
textarea { padding: 1em; width: 100%; height: 99%; }
#preview { padding: 1em; }
.larger { font-size: larger; }
.smaller { font-size: smaller; }
</style>
<script type="text/javascript" src="/libs/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/libs/popper/popper.min.js"></script>
<script type="text/javascript" src="/libs/bootstrap/bootstrap.min.js"></script>
<#if markdown><script type="text/javascript" src="/libs/marked/marked.min.js"></script></#if>
<#if markdown><script type="text/javascript" src="/libs/prism/prism.min.js" data-manual></script></#if>
<script type="text/javascript" src="/nimbus.js"></script>
<script type="text/javascript" src="/langs/${lang}.js"></script>
</head>
<body class="nimbus-hidden">
	<header>
		<div class="float-left">
			<a href="#" class="btn btn-link back" style="display: none;"><i class="material-icons">arrow_back</i></a>
			<button id="saveButton" type="button" class="btn btn-link nimbus-hidden" data-translate="title" title="TextEditorSave"><i class="material-icons">save</i></button>
		</div>

		<div class="btn-group">
			<button id="smallerButton" type="button" class="btn btn-link" data-translate="title" title="TextEditorSmaller"><i class="material-icons">text_fields</i></button>
			<#if markdown><button id="previewButton" type="button" class="btn btn-link" data-translate="title" title="TextEditorPreview"><i class="material-icons">pageview</i></button></#if>
			<#if markdown><a id="exportButton" href="#" type="button" class="btn btn-link" data-translate="title" title="TextEditorExport"><i class="material-icons">cloud_download</i></a></#if>
			<button id="largerButton" type="button" class="btn btn-link" data-translate="title" title="TextEditorLarger"><i class="material-icons">format_size</i></button>
		</div>

		<div class="float-right">
			<div class="btn-group">
				<button id="lineSeparatorButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="TextEditorLineSeparator" aria-haspopup="true" aria-expanded="false"><i class="material-icons">wrap_text</i></button>
				<div id="lineSeparatorMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="lineSeparatorButton">
					<button class="dropdown-item" data-separator="crlf" data-translate="text">TextEditorLineSeparatorCRLF</button>
					<button class="dropdown-item" data-separator="lf" data-translate="text">TextEditorLineSeparatorLF</button>
					<button class="dropdown-item" data-separator="cr" data-translate="text">TextEditorLineSeparatorCR</button>
				</div>
			</div>
		</div>
	</header>
	<main>
		<textarea class="nimbus-hidden" autofocus data-translate="placeholder" placeholder="TextEditorPlaceholder"
			style="font-family: monospace; white-space: pre; overflow: auto; border: 0; "></textarea>
		<#if markdown><div id="preview" class="nimbus-hidden"></div></#if>
	</main>
	<footer>
	</footer>
<script>
"use strict";

function getLineSeparator(content) {
	if (!content || content.indexOf('\r\n') >= 0)
		return 'crlf';
	if (content.indexOf('\n') >= 0)
		return 'lf';
	return 'cr';
}

function formatLines(content, separator) {
	return content.replace('\\r\\n', '\n').replace('\\r', '\n').split('\n').join(separator.replace('cr', '\r').replace('lf', '\n'));
}

<#if markdown>
function markdownToHtml(text) {
	// https://marked.js.org/#/USING_PRO.md#renderer
	var renderer = new marked.Renderer();
	renderer.link = function(href, title, text) {
		var t = title ? ' title="' + title + '"' : '';
		return '<a target="_blank" href="' + href + '"' + t + '>' + text + '</a>';
	};
	renderer.image = function(href, title, alt) {
		var t = title ? ' title="' + title + '"' : '';
		var a = alt ? ' alt="' + alt + '"' : '';
		return '<img class="img-fluid" src="' + href + '"' + t + a + ' />';
	};
	renderer.table = function(header, body) {
		var h = header ? '<thead>' + header + '</thead>' : '';
		var b = body ? '<tbody>' + body + '</tbody>' : '';
		return '<table class="table table-sm table-responsive">' + h + b + '</table>';
	};
	renderer.blockquote = function(text) {
		return '<blockquote class="border-left ml-4 pl-2 border-dark">' + text + '</blockquote>';
	};
	renderer.code = function(code, language, escaped) {
		if (typeof Prism === 'undefined' || !language || !Prism.languages[language])
			return '<pre class="language-none"><code>' + code + '</code></pre>';
		var c = Prism.highlight(code, Prism.languages[language]);
		return ''
			+ '<div class="code-toolbar">'
			+ '  <pre class="language-' + language + '"><code>' + c + '</code></pre>'
			+ '  <div class="toolbar"><div class="toolbar-item"><span>' + language + '</span></div></div>'
			+ '</div>';
	};
	// https://marked.js.org/#/USING_ADVANCED.md#options
	return marked(text || '', {
		// baseUrl: null, // null is the default value
		breaks: true,
		renderer: renderer,
		// sanitize: false, // false is the default value
		xhtml: true
	});
}
</#if>

//Initialiser la page
NIMBUS.init(['text.js'], function() {
	// En haut à gauche, le bouton "Retour"
	$('.back').toggle(!!'${fromUrl}').attr('title', '${fromTitle}').attr('href', '${fromUrl}');
	// L'IHM est prête, on l'affiche
	$(document.body).removeClass('nimbus-hidden');
	// Identifiant de l'élément édité
	var itemId = ${itemId};
	// Récupération du contenu du fichier
	$.get({
		url: '/files/stream/' + itemId,
		dataType: 'text'
	}).then(function(content, textStatus, jqXHR) {
		var lineSeparator = getLineSeparator(content),
			textarea = $('textarea').text(content),
			saveButton = $('#saveButton'),
			filename = NIMBUS.utils.getFileNameFromContentDisposition(jqXHR);

		$('title').text(filename);

		// Rétrécir le texte
		$('#smallerButton').click(function() {
			if (textarea.parent().is('.larger'))
				textarea.unwrap();
			else
				textarea.wrap('<div class="smaller" />');
		});
		// Agrandir le texte
		$('#largerButton').click(function() {
			if (textarea.parent().is('.smaller'))
				textarea.unwrap();
			else
				textarea.wrap('<div class="larger" />');
		});
		<#if markdown>
		// Passer du mode d'édition à la prévisualisation HTML et inversement 
		$('#previewButton').click(function(event) {
			var preview = $('#preview');
			if (preview.hasClass('nimbus-hidden')) {
				// Passer en prévisualisation
				preview.siblings().hide();
				preview.html(markdownToHtml(textarea.val())).removeClass('nimbus-hidden');
			} else {
				// Repasser en édition
				preview.empty().addClass('nimbus-hidden');
				preview.siblings().show();
			}
			$('#smallerButton,#largerButton').toggle();
		});
		// Exporter la note en HTML
		$('#exportButton').attr('download', filename.replace('.md', '.html').replace('.markdown', '.html')).click(function() {
			var html = '<!DOCTYPE html>'
				+ '\n<html>'
				+ '\n\t<head>'
				+ '\n\t\t<title>' + filename + '</title>'
				+ '\n\t\t<meta charset="UTF-8">'
				+ '\n\t\t<link rel="stylesheet" href="${baseURL}/preferences/theme.css" />'
				+ '\n\t\t<link rel="stylesheet" href="${baseURL}/libs/prism/prism.min.css" />'
				+ '\n\t\t<script type="text/javascript" src="${baseURL}/libs/prism/prism.min.js"><' + '/script>'
				+ '\n\t</head>'
				+ '\n\t<body class="m-3">'
				+ '\n' + markdownToHtml(textarea.val())
				+ '\n\t</body>'
				+ '\n</html>';
			//$(this).attr('href', 'data:text/html;charset=UTF-8;base64,' + btoa(html));
			$(this).attr('href', 'data:text/html;charset=UTF-8,' + encodeURIComponent(html));
		});
		</#if>

		$('#lineSeparatorMenu').find('[data-separator=' + lineSeparator + ']').addClass('active');
		$('#lineSeparatorMenu').click('button', function(event) {
			var button = $(event.target).closest('button');
			lineSeparator = button.attr('data-separator');
			button.addClass('active').siblings().removeClass('active');
			saveButton.removeClass('nimbus-hidden');
		});

		textarea.removeClass('nimbus-hidden').on('input', function() {
			saveButton.removeClass('nimbus-hidden');
		});

		saveButton.on('click', function() {
			var text = formatLines(textarea.val(), lineSeparator);
			NIMBUS.utils.updateFile(itemId, new Blob([text], { type: "text/plain" })).then(function() {
				saveButton.addClass('nimbus-hidden');
				textarea.removeClass('border border-danger')
			}, function() {
				textarea.addClass('border border-danger');
			})
		});
	});
});
</script>

</body>
</html>
