<!DOCTYPE html>
<html class="nimbus-viewer nimbus-static-toolbars">
<head>
<title data-translate="text">TextEditorTitle</title>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="robots" content="noindex, nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link type="image/x-icon" rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="/preferences/theme.css" />
<link type="text/css" rel="stylesheet" href="/libs/material-icons/material-icons-custom.css" />
<link type="text/css" rel="stylesheet" href="/nimbus.css" />
<style>
.larger { font-size: larger; }
.smaller { font-size: smaller; }
</style>
<script type="text/javascript" src="/libs/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/libs/popper/popper.min.js"></script>
<script type="text/javascript" src="/libs/bootstrap/bootstrap.min.js"></script>
<script type="text/javascript" src="/nimbus.js"></script>
<script type="text/javascript" src="/langs/${lang}.js"></script>
</head>
<body class="nimbus-hidden">
	<header>
		<div class="float-left">
			<a href="#" class="btn btn-link back" style="display: none;"><i class="material-icons">arrow_back</i></a>
			<button id="saveButton" type="button" class="btn btn-link nimbus-hidden" data-translate="title" title="TextEditorSave"><i class="material-icons">save</i></button>
		</div>

		<div class="btn-group">
			<button id="smallerButton" type="button" class="btn btn-link" data-translate="title" title="TextEditorSmaller"><i class="material-icons">text_fields</i></button>
			<button id="largerButton" type="button" class="btn btn-link" data-translate="title" title="TextEditorLarger"><i class="material-icons">format_size</i></button>
		</div>

		<div class="float-right">
			<button id="lineSeparatorButton" type="button" class="btn btn-link" data-toggle="dropdown" data-translate="title" title="TextEditorLineSeparator" aria-haspopup="true" aria-expanded="false"><i class="material-icons">wrap_text</i></button>
			<div id="lineSeparatorMenu" class="dropdown-menu dropdown-menu-right" aria-labelledby="lineSeparatorButton">
			</div>
		</div>
	</header>
	<main>
		<textarea class="nimbus-hidden" autofocus data-translate="placeholder" placeholder="TextEditorPlaceholder"
			style="width: 100%; height: 100%; font-family: monospace; white-space: pre; overflow: auto; border: 0; "></textarea>
	</main>
	<footer>
	</footer>
<script>
"use strict";

var lineSeparators = {
	options: [
		{ value: '\r\n', text: 'TextEditorLineSeparatorCRLF' },
		{ value: '\n', text: 'TextEditorLineSeparatorLF' },
		{ value: '\r', text: 'TextEditorLineSeparatorCR' },
	],
	format: function formatText(content, separator) {
		return content.replace('\\r\\n', '\n').replace('\\r', '\n').split('\n').join(separator);
	},
	detect: function getLineSeparator(content) {
		if (!content || content.indexOf('\r\n') >= 0)
			return '\r\n';
		if (content.indexOf('\n') >= 0)
			return '\n';
		return '\r';
	}
};

//Initialiser la page
NIMBUS.init(['text.js'], function() {
	// Chargement des extensions des fichiers texte
	NIMBUS.utils.textFileExtensions = [<#list textFileExtensions as e>'${e}'<#sep>,</#sep></#list>];
	// En haut à gauche, le bouton "Retour"
	$('.back').toggle(!!'${fromUrl}').attr('title', '${fromTitle}').attr('href', '${fromUrl}');
	// L'IHM est prête, on l'affiche
	$(document.body).removeClass('nimbus-hidden');
	// Identifiant de l'élément édité
	var itemId = ${itemId};
	// Récupération du contenu du fichier
	$.get('/files/stream/' + itemId).then(function(content, textStatus, jqXHR) {
		var lineSeparator = lineSeparators.detect(content),
			textarea = $('textarea').text(lineSeparators.format(content, '\n')),
			saveButton = $('#saveButton');

		$('title').text(NIMBUS.utils.getFileNameFromContentDisposition(jqXHR));

		$('#smallerButton').click(function() {
			if (textarea.parent().is('.larger'))
				textarea.unwrap();
			else
				textarea.wrap('<div class="smaller" />');
		});
		$('#largerButton').click(function() {
			if (textarea.parent().is('.smaller'))
				textarea.unwrap();
			else
				textarea.wrap('<div class="larger" />');
		});

		$('#lineSeparatorMenu').append(lineSeparators.options.map(function(separator) {
			var style = (separator.value === lineSeparator) ? '' : 'display: none;';
			return $('<button class="dropdown-item" />')
				.data('separator', separator)
				.text(NIMBUS.translate(separator.text))
				.prepend('<i class="material-icons text-muted indicator" style="' + style + '">check</i>')
				.get(0);
		})).click('button', function(event) {
			var button = $(event.target).closest('button');
			lineSeparator = button.data('separator').value;
			button.children('.indicator').show();
			button.siblings().children('.indicator').hide();
			saveButton.removeClass('nimbus-hidden');
		});

		textarea.removeClass('nimbus-hidden').on('input', function() {
			saveButton.removeClass('nimbus-hidden');
		});

		saveButton.on('click', function() {
			var text = lineSeparators.format(textarea.val(), lineSeparator);
			NIMBUS.utils.updateFile(itemId, new Blob([text], { type: "text/plain" })).then(function() {
				saveButton.addClass('nimbus-hidden');
				textarea.removeClass('border border-danger')
			}, function() {
				textarea.addClass('border border-danger');
			})
		});
	});
});
</script>

</body>
</html>
